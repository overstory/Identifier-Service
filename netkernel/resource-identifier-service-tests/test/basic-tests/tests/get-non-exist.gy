import org.netkernel.layer0.nkf.INKFRequestContext

import javax.xml.parsers.DocumentBuilderFactory

import static com.jayway.restassured.RestAssured.given;
import static org.hamcrest.Matchers.*;

import javax.xml.namespace.NamespaceContext

INKFRequestContext context = context
String svcroot = context.source("arg:svcroot")

def NamespaceContext namespaces = context.source ("active:idsvc-namespaces-context", NamespaceContext.class)

println (namespaces.toString())
//println ("fetched namespaces: " + namespaces.getNamespaceURI ("e"))
//println ("fetched namespaces: " + namespaces.getNamespaceURI ("i"))

System.clearProperty ("javax.xml.parsers.DocumentBuilderFactory");
realFactory = DocumentBuilderFactory.newInstance();
realFactory.setNamespaceAware (true);
realFactory.setXIncludeAware (true);


// Assert empty body and not found result
given()
        .header ("Accept", "application/vnd.iop.meta.id+xml")
.when()
        .get ("${svcroot}/identifier/id/something-very-unlikely-to-exist".toString())
.then()
        .statusCode (404)
        .body (not (empty()))
//        .body (hasXPath ("/e:errors/e:resource-not-found[e:uri = 'something-very-unlikely-to-exist']", usingNamespaces))
//        .body (hasXPath ("/*/*[e:uri = 'something-very-unlikely-to-exist']", usingNamespaces))
        .body (hasXPath ('/*/*[e:uri = \'something-very-unlikely-to-exist\']', namespaces))
;

context.createResponseFrom("")


